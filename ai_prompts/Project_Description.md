# Project: Roleplay Chat Web App

## 1. Project Overview

The project aims to develop a web application that allows users to engage in roleplay chat sessions with various characters. Users can create and manage their own profiles, which are then used to interact with AI-driven characters. The application will provide a platform for creating, managing, and customizing these chat experiences.

## 2. Core Functionality

The primary function of the application is to enable users to:
- Create and manage user profiles and characters.
- Browse and select characters to chat with.
- Initiate new chat sessions or resume existing ones with selected characters.
- Exchange messages with AI-driven characters within these sessions.
- Customize chat session parameters, including AI models and system prompts.

## 3. Technology Stack

-   **Backend:** Python, Flask, SQLAlchemy ORM
-   **Database:** SQLite
-   **Frontend:** HTML, JavaScript, CSS
-   **AI Interaction:** OpenRouter API (or similar)

## 4. Key Features

### 4.1. User Profiles
- Users can create, view, edit, and delete their profiles.
- Each profile has a unique identifier, label, name, avatar image, and description.
- Profiles are used to represent the user in chat sessions.

### 4.2. Characters
- Users can browse a list of available characters.
- Each character has a unique identifier, label, name, avatar image, and description.
- Users can view character details and initiate chat sessions.
- Users can also create, edit or delete characters.

### 4.3. Chat Sessions & Messaging
- A chat session is tied to a specific character, user profile, AI model, and system prompt.
- Sessions store chat history as a sequence of `message` objects and allow users to continue previous conversations.
- **Message Creation:**
    - **User Messages:** Created when the user submits text through the chat interface. These messages have a `role` of "user".
    - **AI Messages:** Generated by an external AI model (e.g., via OpenRouter API) in response to user messages. These messages have a `role` of "assistant".
- **AI Interaction:**
    - When a user sends a message, the application constructs a prompt and sends it to the configured AI model via an API (e.g., OpenRouter).
    - The full system prompt sent to the AI is a concatenation of:
        - `chatSession.prePrompt` (if `prePromptEnabled` is true)
        - `systemPrompt.content` (from the selected system prompt)
        - `chatSession.postPrompt` (if `postPromptEnabled` is true)
    - The history of messages in the current `chatSession` is also typically sent along with the system prompt for context.
- **Dynamic Configuration:** Users can dynamically change the user profile, system prompt, and AI model during an active session (see 7.3).
- Chat sessions include configurable pre-system prompts and post-system prompts, which can be enabled/disabled and edited directly within the session.

### 4.4. AI Models
- The application supports multiple AI models for driving character responses.
- Each AI model has a unique identifier, label, and description.
- Users can select which AI model a chat session uses.
- Administrative functionality to create and delete AI models.

### 4.5. System Prompts
- System prompts define the context or personality for the AI in a chat session.
- Each system prompt has a unique identifier, label, and content.
- Users can select which system prompt a chat session uses.
- Administrative functionality to create and delete system prompts.

### 4.6. Application Settings
- Global settings for the application.
- Users can define default settings for:
    - AI Model
    - System Prompt
    - User Profile
    - Avatar Image (fallback if a character/profile has no image)

## 5. Data Models

character:id: INTEGER (Primary Key)label: TEXTname: TEXTavatarImage: TEXT (File path or URL)description: TEXTuserProfile:id: INTEGER (Primary Key)label: TEXTname: TEXTavatarImage: TEXT (File path or URL)description: TEXTaiModel:id: INTEGER (Primary Key)label: TEXTdescription: TEXTsystemPrompt:id: INTEGER (Primary Key)label: TEXTcontent: TEXTchatSession:id: INTEGER (Primary Key)startTime: DATETIMEupdatedAt: DATETIMEcharacter_id: INTEGER (Foreign Key to character.id)userProfile_id: INTEGER (Foreign Key to userProfile.id)aiModel_id: INTEGER (Foreign Key to aiModel.id)systemPrompt_id: INTEGER (Foreign Key to systemPrompt.id)prePrompt: TEXTprePromptEnabled: BOOLEANpostPrompt: TEXTpostPromptEnabled: BOOLEANmessage:id: INTEGER (Primary Key)chatSession_id: INTEGER (Foreign Key to chatSession.id)role: TEXT ("user" or "assistant")content: TEXTtimestamp: DATETIMEapplicationSettings: # Assuming a single row table or key-value storedefaultAiModel_id: INTEGER (Foreign Key to aiModel.id)defaultSystemPrompt_id: INTEGER (Foreign Key to systemPrompt.id)defaultUserProfile_id: INTEGER (Foreign Key to userProfile.id)defaultAvatarImage: TEXT (File path or URL)
## 6. Page Descriptions & Navigation

A top header will provide navigation links to the following pages: Home, Characters, User Profiles, System Prompts, AI Models, and Application Settings.

### 6.1. Home Page
- Landing page of the application.
- Display a clickable list of the recent chat sessions, leading to the Chat Page for that session.

### 6.2. Characters Page
- **View:** Displays a list of all characters from the database.
- **Interaction:**
    - Clicking a character navigates to its details page. From the details page, users can:
        - Edit the character's information.
        - Start a new chat session (which navigates to the Chat Page).
        - Resume an existing chat session from the character's chat session list (which navigates to the Chat Page).
- **Management:**
    - Provides access to a character creation page (form with fields for label, name, description, and avatar image).
    - Allows users to delete characters from the application/database.

### 6.3. User Profiles Page
- **View:** Displays a list of all user profiles.
- **Interaction:** Clicking a profile allows viewing and editing its details.
- **Management:**
    - Provides access to a user profile creation page (form with fields for label, name, description, and avatar image).
    - Allows users to delete existing user profiles.
    - **Constraint:** Cannot delete a user profile if it is set as the `defaultUserProfile` in `applicationSettings`.
    - **On Deletion:** If a user profile is deleted, any `chatSession` currently using it must be updated to use the `defaultUserProfile` instead. If no default is set, a new one might need to be created or the user prompted.

### 6.4. System Prompts Page
- **View:** Lists all available system prompts.
- **Management:**
    - Functionality to create new system prompts (form with fields for label and content).
    - Functionality to delete existing system prompts.
    - **Constraint:** Cannot delete a system prompt if it is set as the `defaultSystemPrompt` in `applicationSettings`.
    - **On Deletion:** If a system prompt is deleted, any `chatSession` currently using it must be updated to use the `defaultSystemPrompt` instead. If no default is set, a new one might need to be created or the user prompted.

### 6.5. AI Models Page
- **View:** Lists all available AI models.
- **Management:**
    - Functionality to create new AI models (form with fields for label and description).
    - Functionality to delete existing AI models.
    - **Constraint:** Cannot delete an AI model if it is set as the `defaultAiModel` in `applicationSettings`.
    - **On Deletion:** If an AI model is deleted, any `chatSession` currently using it must be updated to use the `defaultAiModel` instead. If no default is set, a new one might need to be created or the user prompted.

### 6.6. Application Settings Page
- **Functionality:** Allows users to configure default application settings.
- **Controls:**
    - Selectors to choose the `defaultUserProfile`, `defaultSystemPrompt`, and `defaultAiModel`.
    - Field to set the `defaultAvatarImage`.
- **Action:** An "Apply" button to save the selected settings.

### 6.7. Chat Page / Interface
- This is the main interface for user-character interaction.
- **Display:**
    - Shows the history of messages in the current chat session, distinguishing between "user" and "assistant" (AI) messages.
    - Displays character and user profile avatars next to messages.
- **Input:**
    - A text input field for the user to type and send new messages.
- **Controls (Dynamic Configuration - see 7.3):**
    - Selectors to change the active `userProfile`, `systemPrompt`, and `aiModel` for the current session.
    - Toggles to enable/disable `prePrompt` and `postPrompt`.
    - Input fields to directly edit the content of `prePrompt` and `postPrompt` for the current session.

## 7. Specific Behaviors & Rules

### 7.1. Avatar Images
- `avatarImage` fields accept image files (e.g., `jpe`, `jpg`, `jpeg`, `gif`).
- If a `character` or `userProfile` does not have an `avatarImage` specified:
    1.  The `defaultAvatarImage` from `applicationSettings` will be used.
    2.  If no `defaultAvatarImage` is set, a placeholder (e.g., a white square) will be displayed.

### 7.2. Default Settings
- The `defaultSystemPrompt` and `defaultUserProfile` (from `applicationSettings`) are used by default when a user creates a new chat session.
- If no default `systemPrompt`, `userProfile` or `aiModel` exists in `applicationSettings` when needed (e.g., for a new session, or after deleting a default), the application should prompt for their creation or selection.

### 7.3. Dynamic Chat Session Configuration
- Within an active chat session (on the Chat Page), users can:
    - Change the `userProfile` using a selector that lists all created profiles.
    - Change the `systemPrompt` using a selector that lists all created system prompts.
    - Change the `aiModel` using a selector that lists all created AI models.
    - Activate or deactivate `prePrompt` and `postPrompt`.
    - Directly edit the content of `prePrompt` and `postPrompt` (these are specific to the chat session).
